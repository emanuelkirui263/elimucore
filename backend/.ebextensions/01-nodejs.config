.ebextensions/01-nodejs.config
---
option_settings:
  aws:elasticbeanstalk:container:nodejs:
    NodeCommand: "npm start"
    ProxyServer: "nginx"
    GzipCompression: true
    
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    InstanceType: t3.micro
    EC2KeyName: elimucore-key-pair
    
  aws:autoscaling:asg:
    MinSize: 2
    MaxSize: 6
    HealthCheckType: ELB
    HealthCheckInterval: 15
    
  aws:elasticbeanstalk:environment:process:default:
    DeregistrationDelay: 20
    HealthCheckInterval: 15
    HealthCheckPath: /api/health
    HealthyThreshold: 3
    UnhealthyThreshold: 5
    MatcherHTTPCode: "200"
    Port: 3000
    
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 30
    
  aws:elasticbeanstalk:xray:
    XRayEnabled: false
    
  aws:elasticbeanstalk:hostmanager:
    LogPublicationControl: true

packages:
  yum:
    nodejs: []
    npm: []
    
commands:
  01_update_npm:
    command: npm install -g npm@latest
  02_install_dependencies:
    command: npm ci --production
    cwd: /var/app/current
  03_run_migrations:
    command: npm run migrate
    cwd: /var/app/current
    ignoreErrors: true

files:
  "/var/app/current/.env.production":
    mode: "000600"
    owner: webapp
    group: webapp
    content: |
      NODE_ENV=production
      PORT=3000
      LOG_LEVEL=info
      
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/nodejs.conf":
    content: |
      /var/log/nodejs/nodejs.log
